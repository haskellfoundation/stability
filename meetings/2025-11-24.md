---
tags: swg
---

SWG 2025-11-24
==============

Meeting URL: https://meet.jit.si/StableHaskellMeetBiWeekly

Previous meeting [notes](https://github.com/haskellfoundation/stability/blob/main/meetings/2025-11-10.md)

# Attendees

- Trevis Elser
- Teo Camarasu
- Jose Calderon
- Andreas Klebinger
- Simon


# In progress projects

- [hie library split](https://gitlab.haskell.org/jappeace/ghc/-/merge_requests/1)
  - https://gitlab.haskell.org/ghc/ghc/-/issues/18329
  - https://gitlab.haskell.org/ghc/ghc/-/issues/26505
      - https://gitlab.haskell.org/ghc/ghc/-/merge_requests/15024

- Jappie: catagorizing head.hackage https://docs.google.com/spreadsheets/d/1xNAn7qE1X7waI7lAIh9lOUKGuEb9HnRwGWNicaywASk/edit?gid=251085624#gid=251085624
  - [x] Figure out which language extension semantics caused these changes.
  - [x] Draft a haskell.org blog about findings and advanced warnings
  - [x] Fix trevis comments on draft
  - [ ] Put it up for review  on a haskell.org [here](https://github.com/haskell/blog.haskell.org/)

- Trevis: Extension categorization
  - Preparing next proposal

- Jappie: Cabal exact-print proposal
  - Opened a PR for comment parsing! https://github.com/haskell/cabal/pull/11252
  - Still making progress!

- Ben/Andreas/GHC team: Reinstallable `base`
  - Working on blog post to describe project motivation and progress
  - Test suite being moved/decoupled
  - Shout about it more!  Release GHC 10.0 instead of 9.16

- Teo: template-haskell-lift, template-haskell-quasiquoter
    - released. Announcement blog post: https://informal.codes/posts/ann-th-lift-and-quasi/
    - Updated the wiki page a bit: https://gitlab.haskell.org/ghc/ghc/-/wikis/template-haskell/Plan-to-Stabilise-Template-Haskell
    - Backporting 9.14

- Jose: Page listing community volunteers doing important work

# New items

- Meta item, upcoming meetings and end of year holidays:
  - Have meetings scheduled for Decemember 22nd and January 5th, should we skip either or both of these?

- [HLS/hlint interaction, incompatible with ghc-9.10](https://github.com/haskell/haskell-language-server/issues/4674)
  - Result of this is an issue with hlint using ghc-lib-parser for ghc-9.12 but being used in hls
    built with 9.10.

  - It would seem this is a strong indicator of needing a stable interface that tools like hlint can use to robust in the face of ghc changes and that ghc-lib-parser is not currently filling that role well.

  -  Goal: hlint works unchanged on a new version of GHC?  Seems hard.  If not that, what is the goal?
      -  Goal: no GHC release without working hlint.
      -  Problem: there is no interface for the hlint folk to work to.
      -  But hlint **has** to look at the AST doesn't it?
      -  Somehow two copies of the FastString library ended up in one excecutable.
      -  hlint skipped 9.10 because ??? was broken for 9.10, because `exactprint` didn't work for 9.10.
      -  Somehow mysteriously works in 9.12.
      -  If the AST L.H.Syntax was in a separate package, then...
      -  Some muttering about ghc-lib-parser.
          - `ghc-lib-parser` is a clone of the parser part of GHC, and its fairly substantial dependencies in GHC.
          - It clones FastString.
          - Alas both clones use the same global ref to do interning.
          - The clone should use its own, private global.
          - Depending on both `ghc` and `ghc-lib-parser` is a bad idea.
          - HLS depends directly on `ghc`; it uses `hlint` as a plugin (dynamically linked), and it in turn depends on `ghc-lib-parser`.
            ```haskell
             global_ref :: IORef FSMAP
             global_ref = unsafePerformIO (newIORef emptyMap)
             makeFastString :: String -> FastString
             makeFastString s = unsafePerformIO $
                                do { current_map <- readIORef global_ref
                                ...
                                }
            ```

      - Is there a ticket for this problem?
          - Yes: https://github.com/haskell/haskell-language-server/issues/4674
          - Related ghc issue (maybe?)
          - Trevis thinks one could patch `ghc-lib-parser` to "use the right version of FastString", just for GHC 9.10. https://gitlab.haskell.org/ghc/ghc/-/issues/26033
          - **Jose** will talk to the `ghc-lib-parser` maintainers.
          - Is there a medium-term fix (other than the long term one of splitting of new libraries).   **Andreas** will think about it and summarise choices; maybe make a new ticket for this.
      -  A previous tech-proposal to split out a library  https://github.com/haskellfoundation/tech-proposals/pull/56


current implementation:
https://hackage-content.haskell.org/package/ghc-9.12.2/docs/src/GHC.Data.FastString.html#stringTable
```haskell
{-# NOINLINE stringTable #-}
stringTable :: FastStringTable
stringTable = unsafePerformIO $ do
  let !(I# numSegments#) = numSegments
      !(I# initialNumBuckets#) = initialNumBuckets
      loop a# i# s1#
        | isTrue# (i# ==# numSegments#) = s1#
        | otherwise = case newMVar () `unIO` s1# of
            (# s2#, lock #) -> case newFastMutInt 0 `unIO` s2# of
              (# s3#, counter #) -> case newArray# initialNumBuckets# [] s3# of
                (# s4#, buckets# #) -> case newIORef
                    (FastStringTableSegment lock counter buckets#) `unIO` s4# of
                  (# s5#, segment #) -> case writeArray# a# i# segment s5# of
                    s6# -> loop a# (i# +# 1#) s6#
  uid <- newFastMutInt 603979776 -- ord '$' * 0x01000000
  n_zencs <- newFastMutInt 0
  tab <- IO $ \s1# ->
    case newArray# numSegments# (panic "string_table") s1# of
      (# s2#, arr# #) -> case loop arr# 0# s2# of
        s3# -> case unsafeFreezeArray# arr# s3# of
          (# s4#, segments# #) ->
            (# s4#, FastStringTable uid n_zencs segments# #)

  -- use the support wired into the RTS to share this CAF among all images of
  -- libHSghc
#if !MIN_VERSION_GLASGOW_HASKELL(9,3,0,0)
  return tab
#else
  sharedCAF tab getOrSetLibHSghcFastStringTable

-- from the 9.3 RTS; the previous RTS before might not have this symbol.  The
-- right way to do this however would be to define some HAVE_FAST_STRING_TABLE
-- or similar rather than use (odd parity) development versions.
foreign import ccall unsafe "getOrSetLibHSghcFastStringTable"
  getOrSetLibHSghcFastStringTable :: Ptr a -> IO (Ptr a)
#endif
```

If you grep in GHC for `Globals and the RTS` there is comment explaining
the plugin situation to some degree.

# Parked Action Items/Projects

# New for next meeting

## Action items

## Discussion items
